using System.Dynamic;
using Microsoft.Data.SqlClient;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using RepoDb.Enumerations;
using RepoDb.Exceptions;
using RepoDb.Extensions;
using RepoDb.IntegrationTests.Models;
using RepoDb.IntegrationTests.Setup;

namespace RepoDb.IntegrationTests.Operations;

[TestClass]
public class QueryTest
{
    [TestInitialize]
    public void Initialize()
    {
        Database.Initialize();
        Cleanup();
    }

    [TestCleanup]
    public void Cleanup()
    {
        Database.Cleanup();
    }

    #region Query<TEntity>

    [TestMethod]
    public void TestSqlConnectionQueryWithEntityTableNameWithTypeResult()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<string>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            Assert.IsTrue(result.All(e => string.IsNullOrEmpty(e) == false));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithEntityTableName()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithEntityTableNameWithFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithEntityTableNameAsDynamic()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<dynamic>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithEntityTableNameAsExpandoObject()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<ExpandoObject>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == ((dynamic)item).Id);
                Assert.AreEqual(target.ColumnNVarChar, ((dynamic)item).ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithEntityTableNameAsDictionaryStringObject()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IDictionary<string, object>>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == (long)item["Id"]);
                Assert.AreEqual(target.ColumnNVarChar, item["ColumnNVarChar"]);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQuery()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>((object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>((object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithEmptyQueryFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(Enumerable.Empty<QueryField>());

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 3;

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(what: null,
                top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(what: null,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.First(), result.Last());
            Helper.AssertPropertiesEquality(tables.Last(), result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(what: null,
                top: top,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Assert.AreEqual(result.Count(), top);
            Helper.AssertPropertiesEquality(tables.ElementAt(9), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaPrimaryKey()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(last.Id);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaDynamic()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(new { last.Id });

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpression()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.Id == last.Id);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWitNullValue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar == null);

            // Assert
            Assert.AreEqual(0, result.Count());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryField()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(new QueryField(nameof(IdentityTable.Id), last.Id));

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(fields);

            // Assert
            Assert.AreEqual(4, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryFieldsWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 2;
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(fields, top: top);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryFieldsWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(fields, orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(4), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryFieldsWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(fields, orderBy: orderBy.AsEnumerable(), top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(5), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryGroup()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), 5),
            new QueryField(nameof(IdentityTable.ColumnInt), 6)
        };
        var queryGroup = new QueryGroup(fields, Conjunction.Or);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(queryGroup);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryGroupWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 2;
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(queryGroup, top: top);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryGroupWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(queryGroup, orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(4), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaQueryGroupWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(queryGroup, orderBy: orderBy.AsEnumerable(), top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(5), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithTypeResultViaIDbDataParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(new { Id = new SqlParameter("_", 1) },
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(1, result.Count());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithTypeResultViaQueryFieldForIDbDataParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(new QueryField("Id", new SqlParameter("_", 1)),
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(1, result.Count());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithTypeResultViaQueryFieldsForIDbDataParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(new QueryField("Id", new SqlParameter("_", 1)).AsEnumerable(),
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(1, result.Count());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryWithTypeResultViaQueryGroupForIDbDataParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(new QueryGroup(new QueryField("Id", new SqlParameter("_", 1))),
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(1, result.Count());
        }
    }

    [TestMethod, ExpectedException(typeof(MissingFieldsException))]
    public void ThrowExceptionOnSqlConnectionQueryWithInvalidOrderFields()
    {
        // Setup
        var orderBy = new OrderField("InvalidColumn", Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.Query<IdentityTable>(what: null, orderBy: orderBy.AsEnumerable());
        }
    }

    #endregion

    #region Query<TEntity>(Extra Fields)

    [TestMethod]
    public void TestSqlConnectionQueryWithExtraFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<WithExtraFieldsIdentityTable>((object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    #endregion

    #region Query<TEntity>(Array.Contains, String.Contains, String.StartsWith, String.EndsWith)

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithArrayContains()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => values.Contains(c.ColumnNVarChar));

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));

        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringContains()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.Contains("9"));

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(8), result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringStartsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.StartsWith("NVAR"));

            // Assert
            Assert.AreEqual(tables.Count(), result.Count());
            tables.ForEach(table => Helper.AssertPropertiesEquality(table, result.ElementAt(tables.IndexOf(table))));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringEndsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.EndsWith("9"));

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(8), result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithArrayContainsAndStringContains()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => values.Contains(c.ColumnNVarChar) || c.ColumnNVarChar.Contains("4"));

            // Assert
            Assert.AreEqual(3, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithArrayContainsAndStringStartsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => values.Contains(c.ColumnNVarChar) || c.ColumnNVarChar.StartsWith("NVAR"));

            // Assert
            Assert.AreEqual(tables.Count(), result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithArrayContainsAndStringEndsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => values.Contains(c.ColumnNVarChar) || c.ColumnNVarChar.EndsWith("4"));

            // Assert
            Assert.AreEqual(3, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithArrayContainsAsBooleanTrue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => values.Contains(c.ColumnNVarChar) == true);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithArrayContainsAsBooleanFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => values.Contains(c.ColumnNVarChar) == false);

            // Assert
            Assert.AreEqual(8, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithArrayContainsAsBooleanNotEqualsToFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => values.Contains(c.ColumnNVarChar) != false);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithArrayContainsAsUnaryFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => !values.Contains(c.ColumnNVarChar));

            // Assert
            Assert.AreEqual(8, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringContainsAndStartsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.Contains("9") || c.ColumnNVarChar.StartsWith("NVAR"));

            // Assert
            Assert.AreEqual(10, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringContainsAndEndsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.Contains("9") || c.ColumnNVarChar.EndsWith("8"));

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringContainsAsBooleanTrue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.Contains("9") == true);

            // Assert
            Assert.AreEqual(1, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringContainsAsBooleanFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.Contains("9") == false);

            // Assert
            Assert.AreEqual(9, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringContainsAsBooleanNotEqualsToFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.Contains("9") != false);

            // Assert
            Assert.AreEqual(1, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringContainsAsUnaryFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => !c.ColumnNVarChar.Contains("9"));

            // Assert
            Assert.AreEqual(9, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringStartsWithAsBooleanTrue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.StartsWith("NVAR") == true);

            // Assert
            Assert.AreEqual(tables.Count(), result.Count());
            tables.ForEach(table => Helper.AssertPropertiesEquality(table, result.ElementAt(tables.IndexOf(table))));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringStartsWithAsBooleanFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.StartsWith("NVAR") == false);

            // Assert
            Assert.AreEqual(0, result.Count());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringStartsWithAsBooleanNotEqualsToFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.StartsWith("NVAR") != false);

            // Assert
            Assert.AreEqual(tables.Count(), result.Count());
            tables.ForEach(table => Helper.AssertPropertiesEquality(table, result.ElementAt(tables.IndexOf(table))));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringStartsWithAsUnaryFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => !c.ColumnNVarChar.StartsWith("NVAR"));

            // Assert
            Assert.AreEqual(0, result.Count());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringEndsWithAsBooleanTrue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.EndsWith("9") == true);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(tables.First(t => t.Id == result.First().Id), result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringEndsWithAsBooleanFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.EndsWith("9") == false);

            // Assert
            Assert.AreEqual(9, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringEndsWithAsBooleanNotEqualsToFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => c.ColumnNVarChar.EndsWith("9") != false);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(tables.First(t => t.Id == result.First().Id), result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaExpressionWithStringEndsWithAsUnaryFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<IdentityTable>(c => !c.ColumnNVarChar.EndsWith("9"));

            // Assert
            Assert.AreEqual(9, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    #endregion

    #region QueryAsync<TEntity>

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithEntityTableNameWithTypeResult()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<string>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            Assert.IsTrue(result.All(e => string.IsNullOrEmpty(e) == false));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithEntityTableName()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithEntityTableNameWithFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithEntityTableNameAsDynamic()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<dynamic>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithEntityTableNameAsExpandoObject()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<ExpandoObject>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == ((dynamic)item).Id);
                Assert.AreEqual(target.ColumnNVarChar, ((dynamic)item).ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithEntityTableNameAsDictionaryStringObject()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IDictionary<string, object>>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == (long)item["Id"]);
                Assert.AreEqual(target.ColumnNVarChar, item["ColumnNVarChar"]);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsync()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>((object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>((object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithEmptyQueryFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(Enumerable.Empty<QueryField>());

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 3;

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(what: null,
                top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(what: null,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.First(), result.Last());
            Helper.AssertPropertiesEquality(tables.Last(), result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(what: null,
                top: top,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Assert.AreEqual(result.Count(), top);
            Helper.AssertPropertiesEquality(tables.ElementAt(9), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaPrimaryKey()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(last.Id);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaDynamic()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(new { last.Id });

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpression()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.Id == last.Id);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithNullValue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar == null);

            // Assert
            Assert.AreEqual(0, result.Count());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryField()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(new QueryField(nameof(IdentityTable.Id), last.Id));

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(fields);

            // Assert
            Assert.AreEqual(4, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryFieldsWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 2;
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(fields, top: top);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryFieldsWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(fields, orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(4), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryFieldsWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(fields, orderBy: orderBy.AsEnumerable(), top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(5), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryGroup()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), 5),
            new QueryField(nameof(IdentityTable.ColumnInt), 6)
        };
        var queryGroup = new QueryGroup(fields, Conjunction.Or);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(queryGroup);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryGroupWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 2;
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(queryGroup, top: top);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryGroupWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(queryGroup, orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(4), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaQueryGroupWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(queryGroup, orderBy: orderBy.AsEnumerable(), top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(5), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithTypeResultViaIDbDataParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(new { Id = new SqlParameter("_", 1) },
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(1, result.Count());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithTypeResultViaQueryFieldForIDbDataParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(new QueryField("Id", new SqlParameter("_", 1)),
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(1, result.Count());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithTypeResultViaQueryFieldsForIDbDataParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(new QueryField("Id", new SqlParameter("_", 1)).AsEnumerable(),
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(1, result.Count());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithTypeResultViaQueryGroupForIDbDataParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(new QueryGroup(new QueryField("Id", new SqlParameter("_", 1))),
                fields: Field.Parse<IdentityTable>(e => e.ColumnNVarChar));

            // Assert
            Assert.AreEqual(1, result.Count());
        }
    }

    [TestMethod, ExpectedException(typeof(MissingFieldsException))]
    public async Task ThrowExceptionOnSqlConnectionQueryAsyncWithInvalidOrderFields()
    {
        // Setup
        var orderBy = new OrderField("InvalidColumn", Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.QueryAsync<IdentityTable>(what: null, orderBy: orderBy.AsEnumerable());
        }
    }

    #endregion

    #region QueryAsync<TEntity>(Extra Fields)

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncWithExtraFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<WithExtraFieldsIdentityTable>((object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    #endregion

    #region QueryAsync<TEntity>(Array.Contains, String.Contains, String.StartsWith, String.EndsWith)

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithArrayContains()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => values.Contains(c.ColumnNVarChar));

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));

        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringContains()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.Contains("9"));

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(8), result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringStartsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.Contains("NVAR"));

            // Assert
            Assert.AreEqual(tables.Count(), result.Count());
            tables.ForEach(table => Helper.AssertPropertiesEquality(table, result.ElementAt(tables.IndexOf(table))));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringEndsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.EndsWith("9"));

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(8), result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithArrayContainsAndStringContains()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => values.Contains(c.ColumnNVarChar) || c.ColumnNVarChar.Contains("4"));

            // Assert
            Assert.AreEqual(3, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithArrayContainsAndStringStartsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => values.Contains(c.ColumnNVarChar) || c.ColumnNVarChar.StartsWith("NVAR"));

            // Assert
            Assert.AreEqual(tables.Count(), result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithArrayContainsAndStringEndsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => values.Contains(c.ColumnNVarChar) || c.ColumnNVarChar.EndsWith("4"));

            // Assert
            Assert.AreEqual(3, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithArrayContainsAsBooleanTrue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => values.Contains(c.ColumnNVarChar) == true);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithArrayContainsAsBooleanFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => values.Contains(c.ColumnNVarChar) == false);

            // Assert
            Assert.AreEqual(8, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithArrayContainsAsBooleanNotEqualsToFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => values.Contains(c.ColumnNVarChar) != false);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithArrayContainsAsUnaryFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var values = new[] { "NVARCHAR1", "NVARCHAR2" };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => !values.Contains(c.ColumnNVarChar));

            // Assert
            Assert.AreEqual(8, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringContainsAndStartsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.Contains("9") || c.ColumnNVarChar.StartsWith("NVAR"));

            // Assert
            Assert.AreEqual(10, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringContainsAndEndsWith()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.Contains("9") || c.ColumnNVarChar.EndsWith("8"));

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringContainsAsBooleanTrue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.Contains("9") == true);

            // Assert
            Assert.AreEqual(1, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringContainsAsBooleanFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.Contains("9") == false);

            // Assert
            Assert.AreEqual(9, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringContainsAsBooleanNotEqualsToFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.Contains("9") != false);

            // Assert
            Assert.AreEqual(1, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringContainsAsUnaryFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => !c.ColumnNVarChar.Contains("9"));

            // Assert
            Assert.AreEqual(9, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringStartsWithAsBooleanTrue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.StartsWith("NVAR") == true);

            // Assert
            Assert.AreEqual(tables.Count(), result.Count());
            tables.ForEach(table => Helper.AssertPropertiesEquality(table, result.ElementAt(tables.IndexOf(table))));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringStartsWithAsBooleanFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.StartsWith("NVAR") == false);

            // Assert
            Assert.AreEqual(0, result.Count());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringStartsWithAsBooleanNotEqualsToFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.StartsWith("NVAR") != false);

            // Assert
            Assert.AreEqual(tables.Count(), result.Count());
            tables.ForEach(table => Helper.AssertPropertiesEquality(table, result.ElementAt(tables.IndexOf(table))));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringStartsWithAsUnaryFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => !c.ColumnNVarChar.StartsWith("NVAR"));

            // Assert
            Assert.AreEqual(0, result.Count());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringEndsWithAsBooleanTrue()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.EndsWith("9") == true);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(tables.First(t => t.Id == result.First().Id), result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringEndsWithAsBooleanFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.EndsWith("9") == false);

            // Assert
            Assert.AreEqual(9, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringEndsWithAsBooleanNotEqualsToFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => c.ColumnNVarChar.EndsWith("9") != false);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(tables.First(t => t.Id == result.First().Id), result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaExpressionWithStringEndsWithAsUnaryFalse()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<IdentityTable>(c => !c.ColumnNVarChar.EndsWith("9"));

            // Assert
            Assert.AreEqual(9, result.Count());
            result.AsList().ForEach(table => Helper.AssertPropertiesEquality(tables.First(t => t.Id == table.Id), table));
        }
    }

    #endregion

    #region Query(TableName)

    [TestMethod]
    public void TestSqlConnectionQueryViaDynamicTableName()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<dynamic>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.Id, item.Id);
                Assert.AreEqual(target.RowGuid, item.RowGuid);
                Assert.AreEqual(target.ColumnBit, item.ColumnBit);
                Assert.AreEqual(target.ColumnDateTime, item.ColumnDateTime);
                Assert.AreEqual(target.ColumnDateTime2, item.ColumnDateTime2);
                Assert.AreEqual(target.ColumnDecimal, item.ColumnDecimal);
                Assert.AreEqual(target.ColumnFloat, item.ColumnFloat);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaDynamicTableNameWithFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query<dynamic>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableName()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.Id, item.Id);
                Assert.AreEqual(target.RowGuid, item.RowGuid);
                Assert.AreEqual(target.ColumnBit, item.ColumnBit);
                Assert.AreEqual(target.ColumnDateTime, item.ColumnDateTime);
                Assert.AreEqual(target.ColumnDateTime2, item.ColumnDateTime2);
                Assert.AreEqual(target.ColumnDecimal, item.ColumnDecimal);
                Assert.AreEqual(target.ColumnFloat, item.ColumnFloat);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameWithFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameAndWithFewFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                Field.From(new[] { "Id", "RowGuid", "ColumnFloat" }));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.Id, item.Id);
                Assert.AreEqual(target.RowGuid, item.RowGuid);
                Assert.AreEqual(target.ColumnFloat, item.ColumnFloat);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 3;

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                what: null,
                top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                what: null,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.First(), result.Last());
            Helper.AssertPropertiesEquality(tables.Last(), result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                what: null,
                top: top,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Assert.AreEqual(result.Count(), top);
            Helper.AssertPropertiesEquality(tables.ElementAt(9), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaPrimaryKey()
    {
        // Setup
        var tables = Helper.CreateNonIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<NonIdentityTable>(),
                last.Id);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaDynamic()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                new { last.Id });

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryField()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                new QueryField(nameof(IdentityTable.Id), last.Id));

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                fields);

            // Assert
            Assert.AreEqual(4, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryFieldsWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 2;
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                fields,
                top: top);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryFieldsWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                fields,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(4), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryFieldsWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                fields,
                orderBy: orderBy.AsEnumerable(), top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(5), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryGroup()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), 5),
            new QueryField(nameof(IdentityTable.ColumnInt), 6)
        };
        var queryGroup = new QueryGroup(fields, Conjunction.Or);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                queryGroup);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryGroupWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 2;
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                queryGroup,
                top: top);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryGroupWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                queryGroup,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(4), result.Last());
        }
    }

    [TestMethod]
    public void TestSqlConnectionQueryViaTableNameViaQueryGroupWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.Query(ClassMappedNameCache.Get<IdentityTable>(),
                queryGroup,
                orderBy: orderBy.AsEnumerable(),
                top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(5), result.Last());
        }
    }

    [TestMethod, ExpectedException(typeof(KeyFieldNotFoundException))]
    public void ThrowExceptionOnSqlConnectionQueryViaTableNameIfThereIsNoKeyField()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.Query(ClassMappedNameCache.Get<NonKeyedTable>(),
                1);
        }
    }

    [TestMethod, ExpectedException(typeof(MissingFieldsException))]
    public void ThrowExceptionOnSqlConnectionQueryViaTableNameWithInvalidOrderFields()
    {
        // Setup
        var orderBy = new OrderField("InvalidColumn", Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.Query<IdentityTable>(ClassMappedNameCache.Get<IdentityTable>(),
                what: null,
                orderBy: orderBy.AsEnumerable());
        }
    }

    #endregion

    #region QueryAsync(TableName)

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaDynamicTableName()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<dynamic>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.Id, item.Id);
                Assert.AreEqual(target.RowGuid, item.RowGuid);
                Assert.AreEqual(target.ColumnBit, item.ColumnBit);
                Assert.AreEqual(target.ColumnDateTime, item.ColumnDateTime);
                Assert.AreEqual(target.ColumnDateTime2, item.ColumnDateTime2);
                Assert.AreEqual(target.ColumnDecimal, item.ColumnDecimal);
                Assert.AreEqual(target.ColumnFloat, item.ColumnFloat);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaDynamicTableNameWithFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync<dynamic>(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableName()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null);

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.Id, item.Id);
                Assert.AreEqual(target.RowGuid, item.RowGuid);
                Assert.AreEqual(target.ColumnBit, item.ColumnBit);
                Assert.AreEqual(target.ColumnDateTime, item.ColumnDateTime);
                Assert.AreEqual(target.ColumnDateTime2, item.ColumnDateTime2);
                Assert.AreEqual(target.ColumnDecimal, item.ColumnDecimal);
                Assert.AreEqual(target.ColumnFloat, item.ColumnFloat);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameWithFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                fields: Field.From(nameof(IdentityTable.Id), nameof(IdentityTable.ColumnNVarChar)));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.ColumnNVarChar, item.ColumnNVarChar);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameAndWithFewFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                (object?)null,
                Field.From(new[] { "Id", "RowGuid", "ColumnFloat" }));

            // Assert
            Assert.AreEqual(tables.Count, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Assert.AreEqual(target.Id, item.Id);
                Assert.AreEqual(target.RowGuid, item.RowGuid);
                Assert.AreEqual(target.ColumnFloat, item.ColumnFloat);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 3;

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                what: null,
                top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                what: null,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.First(), result.Last());
            Helper.AssertPropertiesEquality(tables.Last(), result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                what: null,
                top: top,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Assert.AreEqual(result.Count(), top);
            Helper.AssertPropertiesEquality(tables.ElementAt(9), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaPrimaryKey()
    {
        // Setup
        var tables = Helper.CreateNonIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<NonIdentityTable>(),
                last.Id);

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaDynamic()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                new { last.Id });

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryField()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                new QueryField(nameof(IdentityTable.Id), last.Id));

            // Assert
            Assert.AreEqual(1, result.Count());
            Helper.AssertPropertiesEquality(last, result.First());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryFields()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                fields);

            // Assert
            Assert.AreEqual(4, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryFieldsWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 2;
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                fields,
                top: top);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryFieldsWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                fields,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(4), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryFieldsWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                fields,
                orderBy: orderBy.AsEnumerable(), top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(5), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryGroup()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var last = tables.Last();
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), 5),
            new QueryField(nameof(IdentityTable.ColumnInt), 6)
        };
        var queryGroup = new QueryGroup(fields, Conjunction.Or);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                queryGroup);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryGroupWithTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var top = 2;
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                queryGroup,
                top: top);

            // Assert
            Assert.AreEqual(2, result.Count());
            result.AsList().ForEach(item =>
            {
                var target = tables.First(t => t.Id == item.Id);
                Helper.AssertPropertiesEquality(target, item);
            });
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryGroupWithOrderBy()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                queryGroup,
                orderBy: orderBy.AsEnumerable());

            // Assert
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(4), result.Last());
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionQueryAsyncViaTableNameViaQueryGroupWithOrderByAndTop()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);
        var fields = new[]
        {
            new QueryField(nameof(IdentityTable.ColumnDecimal), Operation.GreaterThanOrEqual, 5),
            new QueryField(nameof(IdentityTable.ColumnInt), Operation.LessThanOrEqual, 8)
        };
        var queryGroup = new QueryGroup(fields);
        var top = 3;
        var orderBy = new OrderField(nameof(IdentityTable.ColumnInt), Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.QueryAsync(ClassMappedNameCache.Get<IdentityTable>(),
                queryGroup,
                orderBy: orderBy.AsEnumerable(),
                top: top);

            // Assert
            Assert.AreEqual(top, result.Count());
            Helper.AssertPropertiesEquality(tables.ElementAt(7), result.First());
            Helper.AssertPropertiesEquality(tables.ElementAt(5), result.Last());
        }
    }

    [TestMethod, ExpectedException(typeof(KeyFieldNotFoundException))]
    public async Task ThrowExceptionOnSqlConnectionQueryAsyncViaTableNameIfThereIsNoKeyField()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            await connection.QueryAsync(ClassMappedNameCache.Get<NonKeyedTable>(),
                1);
        }
    }

    [TestMethod, ExpectedException(typeof(MissingFieldsException))]
    public async Task ThrowExceptionOnSqlConnectionQueryAsyncViaTableNameWithInvalidOrderFields()
    {
        // Setup
        var orderBy = new OrderField("InvalidColumn", Order.Descending);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.QueryAsync<IdentityTable>(ClassMappedNameCache.Get<IdentityTable>(),
                what: null,
                orderBy: orderBy.AsEnumerable());
        }
    }

    #endregion

    class DateTimeItems
    {
        public DateTime DateTime { get; set; }
        public DateTime? DateTimeNullable { get; set; }

        public DateTimeOffset DateTimeOffset { get; set; }
        public DateTimeOffset? DateTimeOffsetNullable { get; set; }

#if NET
        public DateOnly DateOnly { get; set; }
        public DateOnly? DateOnlyNullable { get; set; }
#endif
    }

    [TestMethod]
    public void TestDateTimeCasts()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            var dt = DateTimeOffset.Now.Date.AddDays(14); // Converts to DateTime, without you knowing
            DateTimeOffset dto = DateTimeOffset.Now.Date.AddDays(14);

            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateTime < dt));
            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateTimeNullable < dt));
            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateTimeOffset < dt));
            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateTimeOffsetNullable < dt));

            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateTime < dto));
            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateTimeNullable < dto));
            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateTimeOffset < dto));
            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateTimeOffsetNullable < dto));
#if NET
            DateOnly dateOnly = DateOnly.FromDateTime(dt); // Converts to DateTime, without you knowing
            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateOnly < dateOnly));
            Assert.IsNotNull(QueryGroup.Parse<DateTimeItems>(x => x.DateOnlyNullable < dateOnly));
#endif

            Assert.AreEqual("([DateTime] < @DateTime)", QueryGroup.Parse<DateTimeItems>(x => x.DateTime < dto).GetString(connection.GetDbSetting()));
            Assert.AreEqual("([DateTimeOffset] < @DateTimeOffset)", QueryGroup.Parse<DateTimeItems>(x => x.DateTimeOffset < dt).GetString(connection.GetDbSetting()));
        }
    }
}
